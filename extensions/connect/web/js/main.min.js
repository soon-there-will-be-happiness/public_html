var auth_window,atach_window,is_ios_mobile=/iPad|iPhone|iPod/.test(navigator.userAgent),connect_attch=new ConnectAttch,connect_end_res={check:[],click:[]};window.jQuery?($("a[data-connect]").click(function(){return button=$(this),href=button.attr("href"),"http"==href.substring(0,4)||(service=button.data("connect"),service&&connect_attch.buttonClick(service,button),!1)}),window.onload=function(){$("a[data-connect]").each(function(){button=$(this),service=button.data("connect"),service&&connect_attch.buttonCheck(service,button)})}):console.log("jQuery is not loaded");var connect_s_check=[];function ConnectAttch(){var t,e,n;function o(t,e){e.data("connect-setting_text")&&("setting"==t||"setting"==e.data("connect-method")||4===connect_s_check[t]&&!e.data("connect-attach_text")||5===connect_s_check[t]&&!e.data("connect-unlink_text")||!e.data("connect-attach_text")&&!e.data("connect-unlink_text"))?(0==$("#connect_setting").length?(e.html('<span class="loading_text-ani"></span>'),n="error"):(e.html(e.data("connect-setting_text")),n="setting"),e.attr("data-connect-method",n),e.data("connect-method",n),e.attr("href","///")):5===connect_s_check[t]&&e.data("connect-unlink_text")&&e.data("connect-attach_text")?(e.html(e.data("connect-unlink_text")),n="unlink",e.attr("data-connect-method",n),e.data("connect-method",n),is_ios_mobile?c(e,n,t):e.attr("href","///")):4===connect_s_check[t]&&e.data("connect-attach_text")?(e.html(e.data("connect-attach_text")),n="attach",e.attr("data-connect-method",n),e.data("connect-method",n),is_ios_mobile?c(e,n,t):e.attr("href","///")):(e.data("set_elmnt_id")&&(hide_elmnt=e.parents('[data-id="'+e.data("set_elmnt_id")+'"]'))&&hide_elmnt.remove(),e.remove())}function c(t,e,n,o){if(o)return t.attr("href",o),void t.attr("target","_blank");$.ajax({type:"POST",url:"/connect/jquery/"+n,data:{method:e},success:function(e){connect_end_res.click.push(e),"success"==e.status&&(t.attr("href",e.result.link),t.attr("target","_blank"))}})}function a(o,c){return!!(c.data("connect-method")&&n&&n!=c.data("connect-method")||t&&e&&t!=c&&e!=o)&&i()}function i(){return!(!window[e]||window[e].closed)&&(window[e].close(),window[e]=null,o(e,t),!0)}this.buttonCheck=function(t,e){connect_s_check[t]?o(t,e):$.ajax({type:"POST",url:"/connect/jquery/"+t,data:{method:"check_attach"},success:function(n){connect_end_res.check.push(n),"success"==n.status?"connected"==n.comment?connect_s_check[t]=5:"not attached"==n.comment?connect_s_check[t]=4:connect_s_check[t]=3:"disabled"==n.comment?connect_s_check[t]=2:connect_s_check[t]=1,o(t,e)}})},this.buttonClick=function(o,s){if(!a(o,s)){if(n="attach",s.data("connect-method")&&(n=s.data("connect-method")),"setting"==n)return $("#connect_setting").length>0?UIkit.modal($("#connect_setting")).show():s.remove(),!1;if("error"==n&&s.remove(),window[o]&&!window[o].closed)return window[o].focus();$.ajax({type:"POST",url:"/connect/jquery/"+o,data:{method:n},success:function(r){connect_end_res.click.push(r),"success"==r.status&&(setTimeout(function(){(is_ios_mobile||void 0===window[o])&&c(s,n,o,r.result.link)},500),t=s,e=o,r.result.link&&(window[o]=window.open(r.result.link,"_blank","top=100, left=100, width=600, height=500, location=no, resizable=yes, toolbar=no")),"connected"==r.comment&&(connect_s_check[o]=5,i()),setTimeout(function(){void 0!==window[o]&&function o(c,s){if(a(c,s))return;$.ajax({type:"POST",url:"/connect/jquery/"+c,data:{method:"check_attach"},success:function(a){"success"==a.status&&(t=s,e=c,"connected"==a.comment?(connect_s_check[c]=5,"attach"==n?i():setTimeout(function(){o(c,s)},2e3)):"not attached"==a.comment&&(connect_s_check[c]=4,"unlink"==n?i():setTimeout(function(){o(c,s)},2e3)))}})}(o,s)},1e3))}})}}}function Connect(t,e,n){msg_body=document.getElementById("msg_"+t).parentElement.parentElement;var o=new ElementController,c=document.getElementById(t),a=c.querySelector('input[name="enter"]'),i=c.querySelector('input[name="email"]'),s=c.querySelector('input[name="remember_me"]'),r=c.querySelector('input[name="pass"]'),l=c.querySelector(".modal-form-forgot-wrap"),u="",d=null;function h(e){document.getElementById("load-"+e+"-"+t).style.display="none",window[e]&&!window[e].closed&&window[e].close(),window[e]=null,window[d]&&!window[d].closed||(o.unsetDisabled(a,l,s,i,r),o.unsetReadonly(i,r))}function m(o,c){if(!c&&(d!=o||window[o]&&window[o].closed||auth_window!=window[o]))return h(o);var a="time="+n+"&connect_token="+e+"&hash="+u+"&email="+i.value;s.checked&&(a+="&remember=1");var r=new XMLHttpRequest;r.open("POST","/connect/authLoad/"+o,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.send(a),r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status){var e=JSON.parse(r.responseText);e.result&&e.result.msg&&(document.getElementById("msg_"+t).innerHTML=e.result.msg),"success"==e.status?(h(o),e.result.url?(window.location.href=e.result.url,window.location.replace(e.result.url),window.location.reload()):(window.location.reload(),location.reload())):"hash not found"!=e.comment&&(d=null)}else d=null},setTimeout(function(){m(o)},1500)}window.addEventListener("focus",function(){m(d||"check",1)}),this.auth=function(n,c){if(window[n]&&!window[n].closed)return window[n].focus();var h="time=<?=$time?>&serviceID="+c+"&connect_token="+e+"&email="+i.value;s.checked&&(h+="&remember=1");var w=new XMLHttpRequest;w.open("POST","/connect/auth/"+n,!0),w.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),w.send(h),w.onreadystatechange=function(){if(4==w.readyState&&200==w.status){var e=JSON.parse(w.responseText);e.result&&e.result.msg&&(document.getElementById("msg_"+t).innerHTML=e.result.msg),"success"==e.status&&e.result.hash&&(u=e.result.hash,d=n,document.getElementById("load-"+n+"-"+t).style.display="block",e.result.link?(setTimeout(function(){(is_ios_mobile||void 0===window[n])&&function(t,e){var n=document.getElementById("ConnectGoLink_vkontakte");null!=n&&msg_body.removeChild(document.getElementById("ConnectGoLink_vkontakte"));null!=(n=document.getElementById("ConnectGoLink_telegram"))&&msg_body.removeChild(document.getElementById("ConnectGoLink_telegram"));(n=document.createElement("a")).setAttribute("href",t),n.setAttribute("target","_blank"),n.setAttribute("class","or_link button btn-add-rev"),n.setAttribute("id","ConnectGoLink_"+e),n.textContent="Кликните, если не открылось окно",msg_body.append(n)}(e.result.link,n)},500),o.setDisabled(a,l,s,i,r),o.setReadonly(i,r),window[n]=window.open(e.result.link,"_blank","top=100, left=100, width=600, height=500, location=no, resizable=yes, toolbar=no"),auth_window=window[n],o.Onclick("auth_window.focus();")):window[n]=null,setTimeout(function(){m(n)},1e3))}}}}function ElementController(){var t="";this.Onclick=function(e){t=e},this.hide=function(){[].forEach.call(arguments,function(t){t.setAttribute("style","display: none !important")})},this.show=function(){[].forEach.call(arguments,function(t){t.removeAttribute("style")})},this.setReadonly=function(){[].forEach.call(arguments,function(t){t.readOnly=!0})},this.unsetReadonly=function(){[].forEach.call(arguments,function(t){t.readOnly=!1})},this.setDisabled=function(){[].forEach.call(arguments,function(e){e.setAttribute("onclick",t+" return false;")})},this.unsetDisabled=function(){[].forEach.call(arguments,function(t){t.removeAttribute("onclick")})}}window.addEventListener("load",function(){var t=new XMLHttpRequest;t.open("GET","/connect/check_auth",!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(""),t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var e=JSON.parse(t.responseText);e.result&&e.result.msg&&(document.getElementById("msg_"+explr).innerHTML=e.result.msg),"success"==e.status&&(e.result.url?(window.location.href=e.result.url,window.location.replace(e.result.url),window.location.reload()):(window.location.reload(),location.reload()))}}});