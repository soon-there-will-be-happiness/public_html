# Connect

## Создание бота
1. Написать https://t.me/BotFather боту
1. Написать /newbot
1. Указать имя бота
1. Указать юзернейм бота
1. Будет успешно получен токен

### Сохранение настроек тг

При сохранении настроек телеграмм вызывается проверка токена
Стек вызовов:
>adminConnectController->actionAjaxSubmit->Connect\Telegram\Model->updSetting

### Вебхуки от тг

Все сообщения от телеграмм приходят в метод connectController::actionWebhook($name).

    ??? - Каким образом настраивается путь для вебхуков?
Путь для вебхуков устанавливается при сохранении настроек телеграмм - отправляется запрос на сервера тг (setWebhook). В методе Connect\Telegram\Model->updSetting()

$name - это имя telegram или vkontakte.
Дальше вызывается соответствующий обработчик(telegram или vkontakte)
В обработчике вызывается метод update()


### Авторизация через тг

Проверка авторизации: /connect/check_auth
При нажатии кнопки "телеграмм" на странице входа, создается запрос на /connect/auth/telegram
А далее создаются запросы на /connect/authLoad/telegram

При нажатии кнопки "start" в боте тг, на сервер приходит вебхук и далее он обрабатывается классом Connect\Telegram\bot\Controller

При добавлении бота в беседу также приходит вебхук, и дальше он обрабатывается в методе update()


### Привязка телеграмма

Отправляется запрос на страницу `connect/jquery/telegram` с запросом перехода в телеграмм.
Юзер отправляет боту сообщение /start.
Приходит вебхук, и дальше он обрабатывается в методе update()


### Отвязка тг

Отправляется запрос на страницу `connect/jquery/telegram` с подтверждением.
При нажатии подтвердить юзер переходит на страницу `/connect/unlink/telegram`


### Добавление участника в группу

При добавлении участника в группу отправляется вебхук

    ??? - при каких условиях участник добавляется в группу?
Ограничений при добавлении пользователя в группу 
	
Из update() вызывается метод `Connect\Telegram\bot\Controller->newChatMembers()`


### Команда в чат
Когда отправляется команда в чат, то боту приходит вебхук, и он обрабатывается в	
методе `Connect\Telegram\bot\Controller->newCommand()`

    ??? - команда в чат - это что? И когда она отправляется?

Команда в чат: это отправка боту сообщения `start`, `getid`, `Notification`. 
Например, отправка команды start происходит, когда юзер хочет привязать тг к лк, или авторизоваться через тг


    ??? - А удаление из группы/чата как работает?в
Для удаления зайцев из чата используется метод Connect\Telegram\bot\src\Telegram->delStowaways();
Вызывается при переходе в настройки расширения телеграмм `/admin/telegramsetting` нажатием
на кнопку "Удалить пользоваталей из чатов, у которых недолжно быть к ним доступа".

### Отправка сообщений
Для отправки сообщения юзеру используется метод `Email::sender()`
В этом методе определяется тип сообщения, с помощью определения метода, который его вызвал.
Все возможные значения перечислены в переменной `Email::$msg_cases`. 
В этом массиве ключ - имя метода, вызвавшее `Email::sender()`, а значение - описание сообщения.
А затем вызывается метод `Connect::sendMessagesByEmail`, который отправляет сообщение юзеру.

Разрешенные типы сообщений хранится в таблице `extensions` настройках расширения `connect->params['when_msg']`.


### Добавление команд
За обработку команд отвечает класс `CommandHandler`. 
Чтобы добавить какую-либо команду, нужно создать метод с именем `cmd<имя команды>`.
И соответственно написать обработчик внутри этого метода.