# Расширение автопилот

Это расширение добавляет интеграцию с сервисом Autopilot.
Автопилот (АП) — это мощное приложение вконтакте, которое позволяет автоматизировать все процессы при выстраивании обучения и продаж в соц.сети.

## Настройка
1. Создать интеграцию с vk в расширении connect.
1. Зарегистрироваться на сайте `https://skyauto.me/` войдя через vk
1. В лк автопилота добавить нужную группу vk: `https://autopilot.pro/groups`
1. В настройке группы автопилота найти пункт `School Master` и указать значения:
    1. Домен сайта — домен без `https://` и т.п
    1. Ключ API — его можно получить на странице настроек интеграции с автопилотом (`/admin/autopilotsetting`)
1. Готово! Теперь можно создавать различные команды.

## Создание заказа через Автопилот

В группе есть товар. Когда юзер нажмет на кнопку "Написать" в товаре, то будет отправлен запрос в School-Master и создаться заказ в системе.

### Настройка
1. Создать товар в группе вк
1. Открыть его, и скопировать часть ссылки: `https://vk.com/club154643562?w=product-154643362_6956871`. Вот эту часть: `6956871`
1. Далее в продукте SM, к которому мы привязываем в vk, добавить алиас: `vk-6956871`
1. Создать команду в автопилоте:
    1. "Если написал сообщение сообществу", текст сообщения без проверки, и "товаром", 
       а также "Email подписчика есть в системе", иначе запросить
    1. "То будут выполнены действия" - "Создать заказ в school-master"
    1. "После этого" - "Отправить сообщение в vk" - текст: "Заказ создан %response.order.payment_link%"
1. Готово!

### Описание callback

Callback обрабатываются в методе `autopilotController->actionApi()`. Данные передаются методом POST.

Основные параметры (без них заказ не будет создан): 
`email` - на какого пользователя создать заказ
`price` - цена заказа (цена берется из этого значения, а не из цены товара в SM)
`vk` - айди юзера vk
`prod_alias` - "алиас продукта" - по нему происходит поиск продукта внутри SM
`key` - ключ api

В случае успешного создания заказа, мы должны вернуть json, формата
    
    {
        "success": 1,//Статус
        "user": {//Данные юзера},
        "order": {
            "id": "94",
            "number": 1684310774,
            "name": "Марафон за 90 дней",
            "price": "7900",
            "state": 0,
            "payment_link": "https://testsm.ysenin.org.ru/pay/1684310774" //Ссылка на оплату
        }
    }

## Передача данных в Автопилот после оплаты

Для этого нужно:
1. Создать команду в автопилоте. Событие - "Входящий запрос". 
1. Указать нужные дополнительные get-параметры. Скопировать ссылку
1. В продукте — События в пункте `HTTP-уведомления` добавить уведомление
1. В пункте "Адрес сайта" - поместить скопированное значение

Теперь, как заказ будет оплачен, то вебхук будет отправлен в автопилот, где можно настроить сценарий

### АУТЕНТИФИКАЦИЯ С ВК
Устарело. Для этого используется connect
