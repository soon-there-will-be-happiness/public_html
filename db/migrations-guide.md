# Миграции
Миграции используются для изменения структуры баз данных.

Миграции нужны разработчикам чтобы при изменении в структуре бд не приходилось вручную выполнять эти запросы

Для пользователей нашей системы: чтобы удостоверится, что база данных актуальна на текущей версии приложения, и в случае чего - актуализировать базу данных.
Также при обновлении системы, сохраняет лог выполненых миграций


За миграции у нас отвечает класс migrationhandler(для вызова из кода), и консольное приложение "php helper"

Стартовый отчет у наших миграций - версия 3.7.6(файл db/migrations/0.sql);


    P.S пока идет тестирование, лучше сделать дамп бд на всякий случай


## Создание миграций
Классы миграций должны наследоваться от класса \Migrations\Migration; Иметь два метода: up(), down()


### Создание таблицы
Чтобы создать миграцию создания таблицы, нужно вести команду(в директории проекта):
    
    php helper make:migration <версия> <имя_файла> --create=<имя_таблицы>

Где <версия> - для какой версии создать миграцию(без точек). Пример: "381"  
<имя_файла> - должно описывать изменение. Пример хорошего названия: "create_books_table"  
<имя_таблицы> - само имя таблицы(без префикса). Пример: "books"  

После этого в папке db/migrations/<версия>/ создастся файл `_timestamp_<имя_файла>.php`   
! Название класса файла должно соответствовать названию файла, за исключением ".php" !  

    class _1669898574_create_test6_table extends Migration {
        public $table = "test6";

        public function up() {
            Schema::create($this->table, "", "");
        }    
        public function down() {
            Schema::dropIfExists($this->table);
        }
    }

Метод `up()` - само действие миграции  
Метод `down()` - содержит откат действия миграции(удаление таблицы)

Класс `Schema` - используется для изменения базы данных

Schema::create("<имя_таблицы>", "<поля_таблицы", "<комментарий_таблицы>") - создает таблицу

Пример (создать таблицу книг):

    public function up() {
        Schema::create($this->table, "
            `id` INT NOT NULL AUTO_INCREMENT COMMENT 'айди книги',
            `title` VARCHAR(256) NOT NULL COMMENT 'название книги',
            `author` TEXT NULL COMMENT 'автор книги',
            PRIMARY KEY (`id`)
        ","таблица книг");
    }

### Обновление таблиц
Создать миграцию редактирования (alter) таблицы:

    php helper make:migration <версия> <имя_файла> --alter=<имя_таблицы>

Пример:

    php helper make:migration 380 alter_books_table --alter=books

Для редактирования структуры таблиц используется метод `table`

Пример (создать колонку date в таблице books):

    public function up() {
        Schema::table($this->table, "ADD `date` VARCHAR(32) NULL COMMENT 'дата выпуска' AFTER `author`");
    }
    public function down() {
        Schema::dropColumnIfExists($this->table, "date");
    }

Пример 2 (редактировать колонку author, добавить дефолтное значение 'none'):

    public function up() {
        Schema::table($this->table, "CHANGE `author` `author` VARCHAR(256) CHARACTER SET utf32 COLLATE utf32_general_ci NULL DEFAULT 'none' COMMENT 'автор книги'");
    }
    public function down() {
        Schema::table($this->table, "CHANGE `author` `author` TEXT CHARACTER SET utf32 COLLATE utf32_general_ci NULL COMMENT 'автор книги'");
    }
    
Также есть дополнительные методы в `Schema`:

`columnNotExists()` - проверить существование колонки в таблице. Если не существует, то вызовется функция, принимаемая 3-им аргументом), или вернет true, если 3-й аргумент отсутствует

`columnExists()` - проверить существование колонки в таблице. Если существует, то вызовется функция, принимаемая 3-им аргументом), или вернет true, если 3-й аргумент отсутствует

*P.S может какие-нибудь еще функции такого рода нужны?*

Пример:

    Schema::columnNotExists($this->table, "<название колонки>", function () {
        //действие, если колонка не существует
    });
    $bool = Schema::columnNotExists($this->table, "<название колонки>");//true, если колонка не существует
    
    Schema::columnExists($this->table, "<название колонки>", function () {
        //действие если колонка существует
    });
    $bool = Schema::columnExists($this->table, "<название колонки>");//true, если колонка существует
    
### Использование сырых запросов в миграциях

Сырые запросы (чистый sql), применяются для действий по типу вставки в бд, удаления и тд.

Создать миграцию (для таблицы books):

    php helper make:migration 380 insert_to_books_table --raw=books

Пример миграции:
    
    public function up() {
        Schema::rawSql($this->table, "INSERT INTO `[TABLE]` (`title`, `author`, `date`) VALUES ('book1', 'autorname', '2022-02-23')");
    }
    public function down() {
        Schema::rawSql($this->table, "DELETE FROM `[TABLE]` WHERE `title` = 'book1' AND `author` = 'autorname'");
    }

Для метода `Schema::rawSql()`, во второй параметр принимается sql-запрос. Для удобства, название таблицы можно заменять на тег: `[TABLE]`
* P.S Может какие-нибудь тегов нужно добавить?*

## Запуск миграций
Для запуска миграций используется команда: `php helper migrate`  
Она установит те миграции, которые не были выполнены  

**Также, можно проверить бд на актуальность, и если нужно - запустить миграции в роуте `admin/settings/migrations`**

### Другие команды
`migrate:rollback` - откатит базу данных на версию 3.7.6, УДАЛИВ все таблицы в бд. Требует подтверждение на выполнение - нужно ввести `Y`

`migrate:fresh` - аналогична команде _migrate:rollback_, но после нее выполнятся миграции.

`migrate:check` - проверить базу данных на актуальность

#### Дополнительные аргументы к командам
`-v=<нужая версия>` - выполнить действие команды до определенной версии

`--showList` - вместо выполнения действия команды, будет показан список миграций на выполнение

`--rollback` - выполнить down() методы у миграций. 
Например, без этого аргумента в случае выполнения команды `migrate` с версии 3.8, миграции поэтапно будут выполняться до последней версии(например 3.8.3) [3.8->3.8.1->3.8.2->3.8.3]
Если добавить аргумент к команде `migrate`, на версии 3.8.3,миграции будут выполняться до самой нижней версии(если есть аргумент `-v=`, то до этой версии). 
Также будет вызываться метод down(), вместо up()[3.8.3->3.8.2->3.8.1->3.8]

### Веб-версия
Веб версия доступна в SM, по адресу `/admin/settings/migrations`  
Она должна быть ограничена в функционале. 

При открытии страницы, выполняется проверка бд (аналогично команде `migrate:check`). Если версии бд и приложения не сходятся, 
то юзеру предлагается запустить миграции, чтобы актуализировать базу данных. Если все в порядке, то покажется сообщение "База данных актуальна", и покажет некоторые детали

## Создание файла sql дампа из миграций

    php helper migrate:dump <версия>

В папке `/db` будет создан файл `<версия>.sql`